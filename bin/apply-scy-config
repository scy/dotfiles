#!/bin/sh
set -e

# Are we on Debian?
on_deb() {
	test -e /etc/debian_version
}

# Are we on a Mac?
on_mac() {
	test "$(uname)" = 'Darwin'
}

# Checks whether the executable $1 is available and in the PATH.
have() {
	which "$1" >/dev/null 2>&1
}

msg() {
	printf 'apply-scy-config: %s\n' "$*"
}

get_default_shell() {
	on_deb && getent passwd "$(whoami)" | cut -d : -f 7
	on_mac && dscl . -read "$HOME" UserShell | sed -e 's/^UserShell: //'
}

# Try to set the default shell to be fish, if available and not already set.
if have fish && ! get_default_shell | grep -q '/fish$'; then
	fishpath="$(which fish)"
	# Make sure it appears in /etc/shells.
	if ! grep -Fqx "$fishpath" /etc/shells; then
		msg 'Adding fish to /etc/shells.'
		printf '%s\n' "$fishpath" | sudo tee -a /etc/shells >/dev/null
	fi
	# Change the shell.
	msg 'Changing default shell to fish.'
	chsh -s "$fishpath"
fi

# If on a Mac, set up the Compose key.
if on_mac; then
	msg 'Setting up unicompose.'
	[ -d "$HOME/proj/unicompose" ] || git clone --recurse-submodules https://github.com/scy/unicompose.git "$HOME/proj/unicompose"
	cd "$HOME/proj/unicompose"
	mkdir -p "$HOME/Library/KeyBindings"
	./convert.py > "$HOME/Library/KeyBindings/DefaultKeyBinding.dict"
	cd - >/dev/null
fi

# Open Karabiner-Elements if installed, to apply key remappings.
if [ -x '/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements' ]; then
	nohup '/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements' >/dev/null 2>&1 &
fi
